# vLLM Playground Container - Ultra Minimal Edition
# Based on Red Hat Universal Base Image 9 Minimal
# This container includes Python, build tools (gcc, git, vim), and the application code
# Users must install Python dependencies after deployment:
#   - vLLM (or vllm-cpu-only)
#   - PyTorch
#   - All WebUI dependencies from requirements.txt
# 
# This approach creates a minimal image (~800MB - 1.2GB)
# Ideal for environments where you want maximum flexibility

FROM registry.redhat.io/ubi9-minimal:latest

USER 0

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    WEBUI_PORT=7860 \
    VLLM_PORT=8000 \
    HOME=/home/vllm \
    PYTHON_VERSION=3.11 \
    PATH="/home/vllm/.local/bin:$PATH"

# Install Python, build dependencies, and development tools
# Build tools are included for pip package compilation
RUN microdnf install -y \
    python3.11 \
    python3.11-pip \
    python3.11-devel \
    gcc \
    gcc-c++ \
    git \
    vim-minimal \
    curl-minimal \
    && microdnf clean all && \
    rm -rf /var/cache/yum && \
    ln -sf /usr/bin/python3.11 /usr/bin/python3 && \
    ln -sf /usr/bin/pip3.11 /usr/bin/pip3

# Create non-root user and make OpenShift compatible
# OpenShift runs with arbitrary UIDs, so we need group permissions
RUN useradd -m -u 1001 -g 0 -s /bin/bash vllm && \
    chmod -R g=u /home/vllm && \
    # Make /etc/passwd writable for OpenShift arbitrary UIDs
    chmod g+rw /etc/passwd && \
    # Create a bashrc that handles the username display
    echo 'export PS1="[\u@\h \W]\\$ "' >> /home/vllm/.bashrc && \
    chown 1001:0 /home/vllm/.bashrc && \
    chmod g=u /home/vllm/.bashrc

# Set working directory
WORKDIR /home/vllm

# Copy the vLLM Playground project files
# Use root group (GID 0) for OpenShift compatibility
COPY --chown=1001:0 . /home/vllm/vllm-playground/

# Make directories group writable for OpenShift arbitrary UIDs
RUN chmod -R g=u /home/vllm/vllm-playground

# Set the working directory to the WebUI
WORKDIR /home/vllm/vllm-playground

# Create entrypoint script to handle arbitrary UIDs in OpenShift
RUN echo '#!/bin/bash' > /home/vllm/uid_entrypoint.sh && \
    echo '' >> /home/vllm/uid_entrypoint.sh && \
    echo '# Add current UID to /etc/passwd if not already present (for OpenShift arbitrary UIDs)' >> /home/vllm/uid_entrypoint.sh && \
    echo 'if ! whoami &> /dev/null; then' >> /home/vllm/uid_entrypoint.sh && \
    echo '  if [ -w /etc/passwd ]; then' >> /home/vllm/uid_entrypoint.sh && \
    echo '    echo "vllm:x:$(id -u):0:vllm user:/home/vllm:/bin/bash" >> /etc/passwd' >> /home/vllm/uid_entrypoint.sh && \
    echo '  fi' >> /home/vllm/uid_entrypoint.sh && \
    echo 'fi' >> /home/vllm/uid_entrypoint.sh && \
    echo '' >> /home/vllm/uid_entrypoint.sh && \
    echo '# Execute the command passed to the script' >> /home/vllm/uid_entrypoint.sh && \
    echo 'exec "$@"' >> /home/vllm/uid_entrypoint.sh && \
    chmod 775 /home/vllm/uid_entrypoint.sh && \
    chown 1001:0 /home/vllm/uid_entrypoint.sh

# Create a comprehensive startup script with installation instructions
RUN echo '#!/bin/bash' > /home/vllm/start.sh && \
    echo '' >> /home/vllm/start.sh && \
    echo 'echo "================================================"' >> /home/vllm/start.sh && \
    echo 'echo "vLLM Playground - Ultra Minimal Container"' >> /home/vllm/start.sh && \
    echo 'echo "================================================"' >> /home/vllm/start.sh && \
    echo 'echo ""' >> /home/vllm/start.sh && \
    echo '' >> /home/vllm/start.sh && \
    echo '# Check if dependencies are installed' >> /home/vllm/start.sh && \
    echo 'DEPS_MISSING=0' >> /home/vllm/start.sh && \
    echo '' >> /home/vllm/start.sh && \
    echo 'if ! python3 -c "import flask" 2>/dev/null; then' >> /home/vllm/start.sh && \
    echo '    DEPS_MISSING=1' >> /home/vllm/start.sh && \
    echo 'fi' >> /home/vllm/start.sh && \
    echo '' >> /home/vllm/start.sh && \
    echo 'if ! python3 -c "import vllm" 2>/dev/null; then' >> /home/vllm/start.sh && \
    echo '    DEPS_MISSING=1' >> /home/vllm/start.sh && \
    echo 'fi' >> /home/vllm/start.sh && \
    echo '' >> /home/vllm/start.sh && \
    echo 'if [ $DEPS_MISSING -eq 1 ]; then' >> /home/vllm/start.sh && \
    echo '    echo "⚠️  DEPENDENCIES NOT INSTALLED"' >> /home/vllm/start.sh && \
    echo '    echo ""' >> /home/vllm/start.sh && \
    echo '    echo "This is an ultra-minimal container. Please install dependencies:"' >> /home/vllm/start.sh && \
    echo '    echo ""' >> /home/vllm/start.sh && \
    echo '    echo "NOTE: Build tools (gcc, gcc-c++, python3.11-devel, git, vim) are pre-installed"' >> /home/vllm/start.sh && \
    echo '    echo ""' >> /home/vllm/start.sh && \
    echo '    echo "STEP 1: Upgrade pip:"' >> /home/vllm/start.sh && \
    echo '    echo "  pip3 install --upgrade pip setuptools wheel --user"' >> /home/vllm/start.sh && \
    echo '    echo ""' >> /home/vllm/start.sh && \
    echo '    echo "STEP 2: Install vLLM (choose one based on your hardware):"' >> /home/vllm/start.sh && \
    echo '    echo ""' >> /home/vllm/start.sh && \
    echo '    echo "  For CUDA GPU:"' >> /home/vllm/start.sh && \
    echo '    echo "    pip3 install --user torch torchvision --index-url https://download.pytorch.org/whl/cu121"' >> /home/vllm/start.sh && \
    echo '    echo "    pip3 install --user vllm"' >> /home/vllm/start.sh && \
    echo '    echo ""' >> /home/vllm/start.sh && \
    echo '    echo "  For CPU only:"' >> /home/vllm/start.sh && \
    echo '    echo "    pip3 install --user torch torchvision --index-url https://download.pytorch.org/whl/cpu"' >> /home/vllm/start.sh && \
    echo '    echo "    pip3 install --user vllm-cpu-only"' >> /home/vllm/start.sh && \
    echo '    echo ""' >> /home/vllm/start.sh && \
    echo '    echo "  For ROCm (AMD GPU):"' >> /home/vllm/start.sh && \
    echo '    echo "    pip3 install --user torch torchvision --index-url https://download.pytorch.org/whl/rocm6.1"' >> /home/vllm/start.sh && \
    echo '    echo "    pip3 install --user vllm"' >> /home/vllm/start.sh && \
    echo '    echo ""' >> /home/vllm/start.sh && \
    echo '    echo "STEP 3: Install WebUI dependencies:"' >> /home/vllm/start.sh && \
    echo '    echo "  pip3 install --user -r /home/vllm/vllm-playground/requirements.txt"' >> /home/vllm/start.sh && \
    echo '    echo ""' >> /home/vllm/start.sh && \
    echo '    echo "STEP 4: After installation, restart container or run:"' >> /home/vllm/start.sh && \
    echo '    echo "  cd /home/vllm/vllm-playground && python3 app.py"' >> /home/vllm/start.sh && \
    echo '    echo ""' >> /home/vllm/start.sh && \
    echo '    echo "================================================"' >> /home/vllm/start.sh && \
    echo '    echo ""' >> /home/vllm/start.sh && \
    echo '    echo "Dropping into shell for manual installation..."' >> /home/vllm/start.sh && \
    echo '    exec /bin/bash' >> /home/vllm/start.sh && \
    echo 'fi' >> /home/vllm/start.sh && \
    echo '' >> /home/vllm/start.sh && \
    echo 'echo "✅ All dependencies installed!"' >> /home/vllm/start.sh && \
    echo 'echo "Starting vLLM Playground..."' >> /home/vllm/start.sh && \
    echo 'echo ""' >> /home/vllm/start.sh && \
    echo '' >> /home/vllm/start.sh && \
    echo '# Start the application' >> /home/vllm/start.sh && \
    echo 'cd /home/vllm/vllm-playground' >> /home/vllm/start.sh && \
    echo 'exec python3 app.py' >> /home/vllm/start.sh && \
    chmod ug+x /home/vllm/start.sh && \
    chown 1001:0 /home/vllm/start.sh && \
    chmod g=u /home/vllm/start.sh

# Expose ports
# 7860 - WebUI interface
# 8000 - vLLM API server (default)
EXPOSE 7860 8000

# Switch to non-root user for runtime
USER 1001

# Set entrypoint with UID fix wrapper
ENTRYPOINT ["/home/vllm/uid_entrypoint.sh"]
CMD ["/bin/bash", "-c", "/home/vllm/start.sh"]

# Health check (more forgiving since app may not be running initially)
HEALTHCHECK --interval=60s --timeout=10s --start-period=300s --retries=5 \
    CMD curl -f http://localhost:7860/api/status || exit 1

